{
  "alias": "weekscheduler",
  "name": "WeekScheduler",
  "descriptor": {
    "type": "latest",
    "sizeX": 10,
    "sizeY": 6,
    "resources": [],
    "templateHtml": "<!-- Timestamp        -->\n<!-- 2019.09.18 13:40 Added inputEnabled option -->\n<!-- 2019.09.12 21:54 -->\n\n<form class=\"week-scheduler-form\" name=\"weekScheduler\"\n    ng-submit=\"updateAttribute($event)\">\n    <div style=\"padding: 8px 8px; margin: auto 0;\">\n        <div class=\"week-scheduler-form__grid\">\n            <div class=\"grid__element_col\">\n                <div>Mandag</div>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Start</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"start[00]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Start\n                        </div>\n                    </div>\n                </md-input-container>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Stopp</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"stop[00]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Stopp\n                        </div>\n                    </div>\n                </md-input-container>\n            </div>\n            <div class=\"grid__element_col\">\n                <div>Tirsdag</div>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Start</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"start[01]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Start\n                        </div>\n                    </div>\n                </md-input-container>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Stopp</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"stop[01]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Stopp\n                        </div>\n                    </div>\n                </md-input-container>\n            </div>\n            <div class=\"grid__element_col\">\n                <div>Onsdag</div>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Start</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"start[02]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Start\n                        </div>\n                    </div>\n                </md-input-container>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Stopp</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"stop[02]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Stopp\n                        </div>\n                    </div>\n                </md-input-container>\n            </div>\n            <div class=\"grid__element_col\">\n                <div>Torsdag</div>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Start</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"start[03]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Start\n                        </div>\n                    </div>\n                </md-input-container>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Stopp</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"stop[03]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Stopp\n                        </div>\n                    </div>\n                </md-input-container>\n            </div>\n            <div class=\"grid__element_col\">\n                <div>Fredag</div>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Start</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"start[04]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Start\n                        </div>\n                    </div>\n                </md-input-container>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Stopp</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"stop[04]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Stopp\n                        </div>\n                    </div>\n                </md-input-container>\n            </div>\n            <div class=\"grid__element_col\">\n                <div>Lørdag</div>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Start</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"start[05]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Start\n                        </div>\n                    </div>\n                </md-input-container>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Stopp</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"stop[05]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Stopp\n                        </div>\n                    </div>\n                </md-input-container>\n            </div>\n            <div class=\"grid__element_col\">\n                <div>Søndag</div>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Start</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-model=\"start[06]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Start\n                        </div>\n                    </div>\n                </md-input-container>\n                <md-input-container\n                    ng-class=\"{'show-label': settings.showLabel}\"\n                    class=\"md-block\" style=\"width: 100%;\">\n                    <label>Stopp</label>\n                    <input required type=\"time\" ng-disabled=\"!inputEnabled\" ng-disabled=\"!inputEnabled\" ng-model=\"stop[06]\">\n                    <div\n                        ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">Stopp\n                        </div>\n                    </div>\n                </md-input-container>\n            </div>\n            <div class=\"grid__element_buttons\">\n                <div class=\"grid__element\">\n                    <md-button\n                        class=\"md-icon-button applyChanges\"\n                        aria-label=\"Update shared attribute\"\n                        type=\"submit\"\n                        ng-disabled=\"checkChangedValues()\"\n                        ng-click=\"isFocused = false\">\n                        <md-icon>check</md-icon>\n                        <md-tooltip md-direction=\"top\">Lagre\n                            endringer</md-tooltip>\n                    </md-button>\n                    <md-button\n                        class=\"md-icon-button discardChanges\"\n                        aria-label=\"Discard changes\"\n                        ng-disabled=\"checkChangedValues()\"\n                        ng-click=\"restoreValues()\">\n                        <md-icon>close</md-icon>\n                        <md-tooltip md-direction=\"top\">\n                            Forkast endringer</md-tooltip>\n                    </md-button>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"week-scheduler-form__grid\" ng-show=\"entityDetected && isValidParameter\" style=\"visibility: hidden\">\n            <div class=\"grid__element_col\">\n                <md-input-container ng-class=\"{'show-label': settings.showLabel}\" class=\"md-block\" style=\"width: 100%;\">\n                    <label>{{labelValue}}</label>\n                    <input required\n                           name=\"attribute\"\n                           ng-model=\"currentValue\"\n                           ng-focus=\"isFocused = true\"\n                           ng-blur=\"changeFocus()\"\n                           maxlength=\"{{settings.maxLength}}\"\n                           minlength=\"{{settings.minLength}}\"\n                    >\n                    <div ng-messages=\"weekScheduler.attribute.$error\">\n                        <div ng-message=\"required\">{{requiredErrorMessage}}</div>\n                    </div>\n                </md-input-container>\n            </div>\n        </div>\n\n        <div style=\"text-align: center; font-size: 18px; color: #a0a0a0;\"\n            ng-hide=\"entityDetected\" ng-bind=\"message\">\n        </div>\n        <div style=\"text-align: center; font-size: 18px; color: #a0a0a0;\"\n            ng-show=\"entityDetected && !dataKeyDetected\">\n            No attribute is selected\n        </div>\n        <div style=\"text-align: center; font-size: 18px; color: #a0a0a0;\"\n            ng-show=\"entityDetected && !isValidParameter\">\n            Timeseries parameter cannot be used in this\n            widget\n        </div>\n    </div>\n</form>",
    "templateCss": ".week-scheduler-form {\n    overflow: hidden;\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n/*\n    border-style: solid;\n    border-color: blue;\n*/\n}\n\n.entity-title {\n    font-weight: bold;\n    font-size: 22px;\n    padding-top: 12px;\n    padding-bottom: 6px;\n    color: #666;\n}\n\n.week-scheduler-form__grid {\n    display: flex;\n/*\n    border-style: solid;\n*/\n}\n.grid__element:first-child {\n    flex: 0;\n}\n.grid__element:last-child {\n    margin-top: 19px;\n    margin-left: 7px;\n    margin-bottom: 40px;\n}\n.grid__element {\n    display: flex;\n/*\n    border-style: solid;\n    border-color: green;\n*/\n}\n\n.grid__element_buttons {\n    display: flex;\n    flex-direction: column;\n    justify-content: flex-end;\n/*\n    border-style: solid;\n    border-color: purple;\n*/\n}\n\n.grid__element_col {\n    display: flex;\n    flex-direction: column;\n    width: 100%;\n/*\n    border-style: solid;\n    border-color: red;\n*/\n}\n\n.grid__element_row {\n    display: flex;\n    flex-direction: row;\n/*\n    border-style: solid;\n    border-color: yellow\n*/\n}\n\n.week-scheduler-form .md-button.md-icon-button {\n    margin: 0;\n}\n\n.week-scheduler-form .md-button.md-icon-button {\n    width: 32px;\n    min-width: 32px;\n    height: 32px;\n    min-height: 32px;\n    padding: 0 !important;\n    margin: 0 !important;\n    line-height: 20px;\n}\n\n.week-scheduler-form .md-icon-button md-icon {\n    width: 20px;\n    min-width: 20px;\n    height: 20px;\n    min-height: 20px;\n    font-size: 20px;\n}\n\n.show-label label {\n    display: block;\n}\n\nlabel {\n    display: none;\n}\n\nmd-toast{\n    min-width: 0;\n}\nmd-toast .md-toast-content {\n    font-size: 14px!important;\n}",
    "controllerScript": "let $scope;\nlet settings;\nlet attributeService;\nlet toast;\nlet utils;\nlet types;\n\n\n// Convert time (date) to string format \"HH:mm:00.0\"\nfunction time2str(t) {\n    return t.getHours() + \":\" + t.getMinutes() + \":0.0\";\n}\n\n// Convert start+stop time to WACNET JSON time tuple\nfunction times2WACNET(start, stop) {\n    return [{\n        time: time2str(start),\n        value: 1\n    }, {\n        time: time2str(stop),\n        value: 0\n    }]\n}\n\n\nself.onInit = function() {\n\n    $scope = self.ctx.$scope;\n    attributeService = $scope.$injector.get(\n        'attributeService');\n    toast = $scope.$injector.get('toast');\n    utils = $scope.$injector.get('utils');\n    types = $scope.$injector.get('types');\n    settings = angular.copy(self.ctx.settings) || {};\n    $scope.settings = settings;\n    $scope.isValidParameter = true;\n    $scope.dataKeyDetected = false;\n    $scope.message = 'No entity selected';\n    $scope.requiredErrorMessage = settings\n        .requiredErrorMessage ||\n        \"Entity attribute is required\";\n    $scope.labelValue = settings.labelValue || \"Value\";\n    $scope.start = [\"\", \"\", \"\", \"\", \"\", \"\", \"\"]\n    $scope.stop = [\"\", \"\", \"\", \"\", \"\", \"\", \"\"]\n    $scope.start_old = [\"\", \"\", \"\", \"\", \"\", \"\", \"\"]\n    $scope.stop_old = [\"\", \"\", \"\", \"\", \"\", \"\", \"\"]\n    $scope.inputEnabled = self.ctx.settings.inputEnabled\n\n    if (self.ctx.datasources && self.ctx.datasources\n        .length) {\n        var datasource = self.ctx.datasources[0];\n        if (datasource.type === 'entity') {\n            if (datasource.entityType === \"DEVICE\") {\n                if (datasource.entityType && datasource\n                    .entityId) {\n                    $scope.entityName = datasource\n                        .entityName;\n                    if (settings.widgetTitle && settings\n                        .widgetTitle.length) {\n                        $scope.titleTemplate = utils\n                            .customTranslation(settings\n                                .widgetTitle, settings\n                                .widgetTitle);\n                    } else {\n                        $scope.titleTemplate = self.ctx\n                            .widgetConfig.title;\n                    }\n\n                    $scope.entityDetected = true;\n                }\n            } else {\n                $scope.message =\n                    'Selected entity cannot have shared attributes';\n            }\n        }\n        if (datasource.dataKeys.length) {\n            if (datasource.dataKeys[0].type !=\n                \"attribute\") {\n                $scope.isValidParameter = false;\n            } else {\n                $scope.currentKey = datasource.dataKeys[\n                    0].name;\n                $scope.dataKeyType = datasource\n                    .dataKeys[0].type;\n                $scope.dataKeyDetected = true;\n            }\n        }\n    }\n\n    self.ctx.widgetTitle = utils\n        .createLabelFromDatasource(self.ctx.datasources[\n            0], $scope.titleTemplate);\n\n    // Restore all original values when user clicks \"X\"\n    $scope.restoreValues = function() {\n        for (i = 0; i < 7; i++) {\n            $scope.start[i] = $scope.start_old[i];\n            $scope.stop[i] = $scope.stop_old[i];\n        }\n\n        $scope.currentValue = $scope.originalValue;\n        $scope.isFocused = false;\n    };\n\n    // Check if any values changed. Return TRUE if any changes.\n    $scope.checkChangedValues = function() {\n        var check = ($scope.originalValue === $scope.currentValue)\n\n        for (i = 0; (i < 7) && check; i++) \n        {\n            check &= ($scope.start[i] === $scope.start_old[i] && \n                $scope.stop[i] === $scope.stop_old[i]);\n        }\n\n        check |= (!$scope.inputEnabled) // Disable input\n        return check;\n    }\n\n    $scope.updateAttribute = function() {\n        if ($scope.entityDetected) {\n            var datasource = self.ctx.datasources[\n            0];\n\n            // Create new week schedule JSON string from input\n            var jsonObj = [\n                times2WACNET($scope.start[00],\n                    $scope.stop[00]),\n                times2WACNET($scope.start[01],\n                    $scope.stop[01]),\n                times2WACNET($scope.start[02],\n                    $scope.stop[02]),\n                times2WACNET($scope.start[03],\n                    $scope.stop[03]),\n                times2WACNET($scope.start[04],\n                    $scope.stop[04]),\n                times2WACNET($scope.start[05],\n                    $scope.stop[05]),\n                times2WACNET($scope.start[06],\n                    $scope.stop[06])\n            ]\n\n            var weekScheduleString = JSON.stringify(\n                jsonObj)\n\n            // Update input filed with new string\n            $scope.currentValue = weekScheduleString\n\n            // Write JSON string to attribute\n            attributeService.saveEntityAttributes(\n                datasource.entityType,\n                datasource.entityId,\n                types.attributesScope.shared\n                .value,\n                [{\n                    key: $scope.currentKey,\n                    value: $scope\n                        .currentValue\n                }]\n            ).then(\n                function success() {\n\n                    // Update the HTML \"previous\" values to the new ones\n                    for (i = 0; i < 7; i++) {\n                        $scope.start_old[i] =\n                            $scope.start[i];\n                        $scope.stop_old[i] =\n                            $scope.stop[i];\n                    }\n\n                    // >>> Debug view\n                    $scope.originalValue =\n                        $scope.currentValue;\n                    // <<< Debug view\n                    if (settings\n                        .showResultMessage) {\n                        toast.showSuccess(\n                            'Update successful',\n                            1000, angular\n                            .element(self\n                                .ctx\n                                .$container\n                                ),\n                            'bottom left');\n                    }\n                },\n                function fail() {\n                    if (settings\n                        .showResultMessage) {\n                        toast.showError(\n                            'Update failed',\n                            angular.element(\n                                self.ctx\n                                .$container\n                                ),\n                            'bottom left');\n                    }\n                }\n            );\n        }\n    };\n\n    $scope.changeFocus = function() {\n        if ($scope.currentValue === $scope\n            .originalValue) {\n            $scope.isFocused = false;\n        }\n    }\n}\n\n/* Long\n[ \n[{\"time\":\"6:1:0.0\",\"value\":1},{\"time\":\"17:1:0.0\",\"value\":0}],\n[{\"time\":\"6:2:0.0\",\"value\":1},{\"time\":\"17:2:0.0\",\"value\":0}],\n[{\"time\":\"6:3:0.0\",\"value\":1},{\"time\":\"17:3:0.0\",\"value\":0}],\n[{\"time\":\"6:4:0.0\",\"value\":1},{\"time\":\"21:4:0.0\",\"value\":0}],\n[{\"time\":\"6:5:0.0\",\"value\":1},{\"time\":\"17:5:0.0\",\"value\":0}],\n[{\"time\":\"9:6:0.0\",\"value\":1},{\"time\":\"15:6:0.0\",\"value\":0}],\n[{\"time\":\"9:7:0.0\",\"value\":1},{\"time\":\"15:7:0.0\",\"value\":0}]\n]\n*/\n/* Short\n[[{\"time\":\"6:0:0.0\",\"value\":1},{\"time\":\"17:0:0.0\",\"value\":0}]]\n\n*/\n\n// Get time from WACNET JSON object\nfunction WACTime2Time(wact, value) {\n    var t = new Date(\"00:00\")\n    if (typeof wact === 'undefined') {\n        return t;\n    }\n\n    for (var v of wact) {\n        if (v.value === value) {\n            t = new Date(moment(v.time, [\"H:m:s.S\"]))\n        }\n    }\n    return t;\n}\n\nself.onDataUpdated = function() {\n\n    try {\n        if ($scope.dataKeyDetected) {\n            if (!$scope.isFocused) {\n\n                var week_schedule = JSON.parse(self.ctx\n                    .data[0].data[0][1])\n\n                // Update HTML based on actual value from attribute change\n                for (i = 0; i < 7; i++) {\n                    $scope.start[i] = $scope.start_old[\n                        i] = WACTime2Time(\n                        week_schedule[i], 1);\n                    $scope.stop[i] = $scope.stop_old[\n                        i] = WACTime2Time(week_schedule[\n                            i], 0);\n                }\n\n                // >>> Debug view\n                $scope.currentValue = $scope\n                    .originalValue = self.ctx.data[0]\n                    .data[0][1];\n                // <<< Debug view\n                $scope.$digest();\n            }\n        }\n    } catch (e) {\n        console.log(e);\n    }\n\n}\n\nself.onResize = function() {\n\n}\n\nself.typeParameters = function() {\n    return {\n        maxDatasources: 1,\n        maxDataKeys: 1\n    }\n}\n\nself.onDestroy = function() {\n\n}",
    "settingsSchema": "{\n    \"schema\": {\n        \"type\": \"object\",\n        \"title\": \"EntitiesTableSettings\",\n        \"properties\": {\n            \"inputEnabled\" : {\n                \"title\" : \"Input enabled\",\n                \"type\": \"boolean\",\n                \"default\" : true\n            },\n            \"widgetTitle\": {\n                \"title\": \"Widget title\",\n                \"type\": \"string\",\n                \"default\": \"\"\n            },\n            \"showLabel\":{\n                \"title\":\"Show label\",\n                \"type\":\"boolean\",\n                \"default\":true\n            },\n            \"labelValue\": {\n                \"title\": \"Label\",\n                \"type\": \"string\",\n                \"default\": \"\"\n            },\n            \"requiredErrorMessage\": {\n                \"title\": \"'Required' error message\",\n                \"type\": \"string\",\n                \"default\": \"\"\n            },\n            \"maxLength\": {\n                \"title\": \"Max length\",\n                \"type\": \"number\",\n                \"default\": \"\"\n            },\n            \"minLength\": {\n                \"title\": \"Min length\",\n                \"type\": \"number\",\n                \"default\": \"\"\n            },\n            \"showResultMessage\":{\n                \"title\":\"Show result message\",\n                \"type\":\"boolean\",\n                \"default\":true\n            }\n        },\n        \"required\": []\n    },\n    \"form\": [\n        \"inputEnabled\", \"widgetTitle\",\n        \"showResultMessage\",\n        \"showLabel\",\n        \"labelValue\",\n        \"requiredErrorMessage\",\n        \"maxLength\",\n        \"minLength\"\n    ]\n}",
    "dataKeySettingsSchema": "{}\n",
    "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.23592248334107624,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"inputEnabled\":false,\"showResultMessage\":true,\"showLabel\":true},\"title\":\"WeekScheduler\",\"dropShadow\":true,\"enableFullscreen\":false,\"enableDataExport\":false,\"widgetStyle\":{},\"titleStyle\":{\"fontSize\":\"16px\",\"fontWeight\":400},\"useDashboardTimewindow\":true,\"showLegend\":false,\"actions\":{},\"displayTimewindow\":true}"
  }
}